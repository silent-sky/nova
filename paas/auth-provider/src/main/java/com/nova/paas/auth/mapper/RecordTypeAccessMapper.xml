<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nova.paas.auth.mapper.RecordTypeAccessMapper">
    <resultMap id="recordTypeAccess" type="com.nova.paas.auth.entity.RecordTypeAccess">
        <id property="id" column="id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="appId" column="app_id"/>
        <result property="roleCode" column="role_code"/>
        <result property="entityId" column="entity_id"/>
        <result property="recordTypeId" column="record_type_id"/>
        <result property="delFlag" column="del_flag"/>
        <result property="modifier" column="modifier"/>
        <result property="updatedAt" column="modify_time"/>
    </resultMap>

    <select id="queryRecordTypeAccessProvider" resultMap="recordTypeAccess">
        select * from auth_recordType_access WHERE tenant_id=#{tenantId} and app_id=#{appId}
        <if test="roleCodes != null and roleCodes.size()>0">
            AND role_code IN
            <foreach item="roles" collection="roleCodes" open="(" separator="," close=")">
                #{roles}
            </foreach>
        </if>
        <if test="entityId != null and entityId.size()>0">
            AND entity_id IN
            <foreach item="entitys" collection="entityId" open="(" separator="," close=")">
                #{entitys}
            </foreach>
        </if>
        <if test="recordTypeId != null and recordTypeId!=''">
            AND record_type_id=#{recordTypeId}
        </if>
        and del_flag=0
    </select>


    <select id="queryRoleRecordTypeByEntitys" resultMap="recordTypeAccess">
        select * from auth_recordType_access WHERE tenant_id=#{tenantId} and app_id=#{appId}
        <if test="entitys != null">
            <choose>
                <when test="entitys.size()==0">
                    AND entity_id in ('')
                </when>
                <otherwise>
                    AND entity_id IN
                    <foreach item="entityIds" collection="entitys" open="(" separator="," close=")">
                        #{entityIds}
                    </foreach>
                </otherwise>
            </choose>
        </if>
        and del_flag=0
    </select>


    <update id="deleteRoleRecordType">
        update auth_recordType_Access set del_flag=1,modifier=#{modifier},modify_time=#{updatedAt} WHERE tenant_id=#{tenantId} and app_id=#{appId}
        and del_flag=0
        <if test="roleCodes != null and roleCodes.size()>0">
            AND role_code IN
            <foreach item="roles" collection="roleCodes" open="(" separator="," close=")">
                #{roles}
            </foreach>
        </if>
        <if test="entityId != null and entityId!='' ">
            AND entity_id=#{entityId}
        </if>
        <if test="recordTypeId != null and recordTypeId!='' ">
            AND record_type_id=#{recordTypeId}
        </if>
        <if test="defaultType != null ">
            AND default_type=#{defaultType}
        </if>
    </update>

</mapper>
