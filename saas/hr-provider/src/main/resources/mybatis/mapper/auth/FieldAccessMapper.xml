<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nova.paas.auth.service.mapper.FieldAccessMapper">
    <resultMap id="fieldAccess" type="com.nova.paas.auth.service.entity.FieldAccess">
        <id property="id" column="id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="appId" column="app_id"/>
        <result property="roleCode" column="role_code"/>
        <result property="entityId" column="entity_id"/>
        <result property="fieldId" column="field_id"/>
        <result property="permission" column="permission"/>
        <result property="delFlag" column="del_flag"/>
        <result property="modifier" column="modifier"/>
        <result property="modifyTime" column="modify_time"/>
    </resultMap>

    <update id="batchDel">
        update auth_field_access set del_flag=1,modifier=#{modifier},modify_time=#{modifyTime} WHERE tenant_id=#{tenantId} and app_id=#{appId} and
        del_flag=0
        <if test="roleCode != null and roleCode!='' ">
            AND role_code=#{roleCode}
        </if>
        <if test="entityId != null and entityId!='' ">
            AND entity_id=#{entityId}
        </if>
        <if test="fieldId != null and fieldId!='' ">
            AND field_id=#{fieldId}
        </if>
    </update>

    <update id="batchDelSupportRoles">
        update auth_field_access set del_flag=1,modifier=#{modifier},modify_time=#{modifyTime} WHERE tenant_id=#{tenantId} and app_id=#{appId} and
        del_flag=0
        <if test="roles != null and roles.size()>0">
            AND role_code IN
            <foreach item="roleCodes" collection="roles" open="(" separator="," close=")">
                #{roleCodes}
            </foreach>
        </if>
        <if test="entityId != null and entityId!='' ">
            AND entity_id=#{entityId}
        </if>
        <if test="fieldId != null and fieldId!='' ">
            AND field_id=#{fieldId}
        </if>
    </update>

    <select id="queryFieldAccess" resultMap="fieldAccess">
        select * from auth_field_access WHERE tenant_id=#{tenantId} and app_id=#{appId} and del_flag=0
        <if test="roleCodes != null and roleCodes.size()>0">
            AND role_Code IN
            <foreach item="roles" collection="roleCodes" open="(" separator="," close=")">
                #{roles}
            </foreach>
        </if>
        <if test="entitys != null and entitys.size()>0">
            AND entity_id IN
            <foreach item="entityIds" collection="entitys" open="(" separator="," close=")">
                #{entityIds}
            </foreach>
        </if>
        <if test="fields != null and fields.size()>0">
            AND field_id IN
            <foreach item="fieldIds" collection="fields" open="(" separator="," close=")">
                #{fieldIds}
            </foreach>
        </if>
    </select>

    <select id="queryFieldAccessByEntityRolesFilter" resultMap="fieldAccess" parameterType="java.util.Map">
        <foreach collection="entityRoles.keys" item="myitem" separator="UNION ALL">
            select * from auth_field_Access where tenant_id=#{tenantId} and app_id=#{appId} and del_flag=0 and entity_id=#{myitem} and role_code IN
            <foreach collection="entityRoles[myitem]" item="myset" open="(" close=")" separator=",">
                #{myset}
            </foreach>
        </foreach>
    </select>

</mapper>
